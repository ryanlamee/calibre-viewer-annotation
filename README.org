#+ARCHIVE: doc/devlog/%s_archive::

* adding annotation (read and write) capability to calibre's ebook-viewer
  
  sporadic work in progress. *last updated on 2015-09-21* and installed against =calibre (calibre 2.38)=

  [[./doc/img/ss-007.png]]
  
  There are 2 main issues we care about here, addressed in headings below

  1. importing, i.e. reading annotations made elsewhere.
  2. editing, i.e. displaying and editing annotations in calibre's
     =ebook-viewer= program. this is doable now. read below for
     details. notes are stored into an =sqlite= database using the
     =okfn/annotator= API and thus their JSON format.

* external dependencies

  - sqlalchemy
    
  which should be installable via pip; due to *PATH HACK* below, we're
  assuming a system install where you know the inclusion path for both
  libraries

** note on elixir

   Previously [[https://pypi.python.org/pypi/Elixir/][elixir]] was an import dependency in this plugin, but
   since development seems to have stagnated since late 2009 we have
   issues like [[http://stackoverflow.com/questions/14201210/impossible-to-initialize-elixir][this one]] resulting from elixir being out of sync with
   the latest sqlalchemy. As a result, *a clone of the entire elixir
   library is included in this plugin*. It is a straight git clone
   of https://github.com/jmg/elixir

   In the future it's probably best to strip this dependency away.
   
* installing+using the plugin

  With calibre 2 this is considerably easier, but this plugin is *NOT*
  pre-packaged and ready to use. This is the only method I'm familiar
  with now. A quick step by step:

  1. ensure you have a working development environment set up
  2. clone this repo
  3. edit the *PATH HACK*
     =ViewerAnnotationPlugin/model/annotator_model.py= in the line
     that follows the comment "CHANGE THIS". Leave the elixir path
     alone for now.  This is to allow calibre to see your local
     install of =sqlalchemy=. It is currently hard-coded
     to search in =/usr/local/lib/python2.7/dist-packages=. There's
     probably a way to make this self-contained but I don't know it.
     [[http://www.mobileread.com/forums/showthread.php?t%3D241076][For now, this may be the simplest way to do it]]
  4. in your terminal/command line program, navigate to the
     =ViewerAnnotationPlugin= directory and run =calibre-customize -b .=
     to install the plugin. A successful installation should give
     you the message =Plugin updated: Viewer Annotation Plugin (0, 0, 1)=.
     If successful, your =ebook-viewer= should incorporate the
     annotations. By default it will create a sqlite database
     =ebook-viewer-annotation.db= into your home directory.
     
* importing annotations

  harder problem. but see [[https://github.com/whacked/calibre-viewer-annotation/tree/nwapp-annotation-import][nwapp branch]] for progress on importing text
  from kindle notes

* development
  
  The base plugin code is loosely taken from [[http://manual.calibre-ebook.com/creating_plugins.html#a-user-interface-plugin][user interface plugin]],
  although the viewer plugin is slightly different. refer to the
  [[http://manual.calibre-ebook.com/plugins.html#viewer-plugins][Viewer plugins]] section in the calibre API documentation.
  
  To play with the code, edit the code in the =ViewerAnnotationPlugin=
  directory, then run

  #+BEGIN_SRC sh :eval never
    calibre-customize -b . && ebook-viewer $PATH_TO_EPUB
  #+END_SRC
  
  and it should launch the viewer with the changes applied.
  
** okfn/annotator files

   current code is hard-coded to expect =annotator-full.1.2.7=
   for javascript/css. For a different version:

   1. visit https://github.com/okfn/annotator/downloads/
   2. if you've unzipped e.g. annotator-full.1.2.7.zip, you should get
      a directory =annotator-full.1.2.7/= with a =.js= and a =.css= file
      inside it. Move this directory into the =ViewerAnnotationPlugin=
      directory.
   3. edit =ViewerAnnotationPlugin/__init__.py= and find the
      =load_javascript= and =run_javascript= sections and make sure the
      paths there correspond to your extracted annotator js/css
      files.

** okfn/annotator plugin (store.js)

   see =store.coffee=; =store.js= is derived from =coffee --compile store.coffee=
   then moved into =ViewerAnnotationPlugin=

* issues

  - either the js file inclusion or css style injection or both cause
    long pauses in the reader when navigating between epub chapter
    boundaries
