<html>

<body>
<link rel="stylesheet" href="{{ url_for('static', filename='annotator.1.2.7/annotator.min.css') }}" />


<style>

table {
    height: 400px;
    table-layout: fixed;
}

td {
    width: 33%;
}

td div,textarea {
    width: 100%;
    height: 100%;
}

#work {
    border: 1px solid black;
}

textarea {
}

</style>

<table>
    <tr>
        <td valign="top">
            <div id="work"></div>
            <button name="add_ann">test add highlight</button>
        </td>
        <td valign="top">
            <textarea name="annotator_json" placeholder="annotator json" readonly="readonly"></textarea>
            <button name="ann2anc">annotator to anchor</button>
        </td>
        <td valign="top">
            <textarea name="anchor_json" placeholder="anchor json" readonly="readonly"></textarea>
            <button name="anc2ann">anchor to annotator</button>
        </td>
    </tr>
</table>

{% for js in [
'bower_components/jquery/jquery.min.js',
'annotator.1.2.7/annotator.js',
'annotator.1.2.7/annotator.store.min.js',
] %}
<script src="{{ url_for('static', filename=js) }}"></script>
{% endfor %}
<script>

$(function() {

    // custom plugin to subscribe to events
    Annotator.Plugin.MyPlugin = function(el) {
        return {
            pluginInit: function() {
                console.log("initializing my plugin");
                this.annotator
                    .subscribe("annotationCreated", function(ann) {
                        console.log("created...");
                        console.log(ann);
                        $("textarea[name=annotator_json]").val(JSON.stringify(ann, null, 4));

                        $.ajax("/annotator2anchor", {
                            data: {annotation: JSON.stringify(ann)},
                            dataType: "json",
                            success: function(resp) {
                                console.log(resp);
                                $("textarea[name=anchor_json]").val(JSON.stringify(resp, null, 4));
                            }
                        });
                    })
                    .subscribe("annotationsLoaded", function(annlist) {
                        console.log("updated...");
                        console.log(annlist);
                    });
            }
        };
    };


    var main_text = "{{ text }}";

    var main = $("#work");
    main.text(main_text);
    main.annotator()
        .annotator("addPlugin", "MyPlugin");

    var annot = {
        "ranges": [
            {
                "start": "",
                "startOffset": 303,
                "end": "",
                "endOffset": 328
            }
        ],
        "quote": "not really no so actually",
        "highlights": [
            {},
            {}
        ],
        "text": "hello highlight"
    }

    $("button[name=add_ann]").click(function() {
        main.data("annotator").setupAnnotation(annot);
        $("textarea[name=annotator_json]").val(JSON.stringify(annot, null, 4));
    });
    $("button[name=ann2anc]").click(function() {
        var ann_json = $("textarea[name=annotator_json]").val();
        $.ajax("/annotator2anchor", {
            method: "post",
            data: {annotation: ann_json},
            dataType: "json",
            success: function(resp) {
                $("textarea[name=anchor_json]").val(JSON.stringify(resp, null, 4));
            }
        });
    });
    $("button[name=anc2ann]").click(function() {
        var anc_json = $("textarea[name=anchor_json]").val();
        $.ajax("/anchor2annotator", {
            method: "post",
            data: {
                anchor: anc_json,
                text: main_text
            },
            dataType: "json",
            success: function(resp) {
                $("textarea[name=annotator_json]").val(JSON.stringify(resp, null, 4));
            }
        });
    });
});

</script>
</body>
</html>
